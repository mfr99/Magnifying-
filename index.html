<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pocket Magnifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.1s ease-out;
        }

        .inverted {
            filter: invert(1) hue-rotate(180deg) contrast(1.2);
        }

        .ui-overlay {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px 16px env(safe-area-inset-bottom);
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            display: flex;
            flex-direction: column;
            gap: 16px;
            pointer-events: none;
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: auto;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        .btn-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-circle:active {
            transform: scale(0.85);
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-active {
            background: #ef4444 !important;
            border-color: #f87171;
        }

        .zoom-pill {
            background: rgba(0,0,0,0.6);
            padding: 4px 16px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.2);
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
        }

        .permission-screen {
            position: fixed;
            inset: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
            z-index: 100;
        }

        .share-btn {
            position: fixed;
            top: env(safe-area-inset-top, 20px);
            right: 20px;
            z-index: 50;
            pointer-events: auto;
        }

        svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .toast {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 38, 38, 0.95);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            display: none;
            z-index: 200;
            max-width: 80%;
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>

    <div id="permission-screen" class="permission-screen">
        <div class="mb-8 p-8 bg-white/10 rounded-full">
            <svg viewBox="0 0 24 24" style="width: 64px; height: 64px;">
                <path d="M12 15a3 3 0 100-6 3 3 0 000 6z"/>
                <path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z" clip-rule="evenodd"/>
            </svg>
        </div>
        <h1 class="text-3xl font-bold mb-2">Magnifier</h1>
        <p class="text-gray-400 mb-10 max-w-xs text-lg">Use your camera as a high-contrast reading aid.</p>
        <button id="start-btn" onclick="initCamera()" class="w-full max-w-xs bg-white text-black font-bold py-5 px-10 rounded-2xl transition-transform active:scale-95 text-xl shadow-xl">
            Open Camera
        </button>
        <p class="mt-6 text-sm text-gray-500">Must be used over HTTPS</p>
    </div>

    <button onclick="shareApp()" class="share-btn btn-circle" style="width: 44px; height: 44px;">
        <svg viewBox="0 0 24 24">
            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
        </svg>
    </button>

    <div id="toast" class="toast"></div>

    <div id="video-container">
        <video id="webcam" autoplay playsinline muted></video>
    </div>

    <div class="ui-overlay">
        <div class="flex justify-center">
            <div id="zoom-value" class="zoom-pill">1.0x Magnification</div>
        </div>

        <div class="controls-row">
            <button id="torch-btn" onclick="toggleTorch()" class="btn-circle">
                <svg viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </button>

            <div class="flex gap-4">
                <button onclick="adjustZoom(-0.5)" class="btn-circle">
                    <svg viewBox="0 0 24 24"><path d="M19 13H5v-2h14v2z"/></svg>
                </button>
                <button onclick="adjustZoom(0.5)" class="btn-circle">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                </button>
            </div>

            <button id="invert-btn" onclick="toggleInvert()" class="btn-circle">
                <svg viewBox="0 0 24 24"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zm0-2V4a8 8 0 110 16z"/></svg>
            </button>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const zoomValueDisplay = document.getElementById('zoom-value');
        const permissionScreen = document.getElementById('permission-screen');
        const torchBtn = document.getElementById('torch-btn');
        const startBtn = document.getElementById('start-btn');
        const invertBtn = document.getElementById('invert-btn');
        const toast = document.getElementById('toast');
        
        let track = null;
        let currentZoom = 1.0;
        let isInverted = false;
        let torchEnabled = false;

        async function initCamera() {
            startBtn.innerText = "Connecting...";
            startBtn.disabled = true;

            try {
                // Try several fallback constraints for broader compatibility
                const constraints = [
                    { video: { facingMode: { exact: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } } },
                    { video: { facingMode: "environment" } },
                    { video: true }
                ];

                let stream = null;
                for (let constraint of constraints) {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia(constraint);
                        if (stream) break;
                    } catch (e) {
                        console.warn("Constraint failed, trying next...", e);
                    }
                }

                if (!stream) throw new Error("Could not access any camera.");

                video.srcObject = stream;
                track = stream.getVideoTracks()[0];
                permissionScreen.style.display = 'none';

                // Monitor for orientation changes
                window.addEventListener('resize', () => {
                    // Small delay to let video settle
                    setTimeout(() => applyZoom(currentZoom), 200);
                });

            } catch (err) {
                startBtn.innerText = "Open Camera";
                startBtn.disabled = false;
                showToast("Camera Error: " + err.message + "\n\nPlease ensure you are using HTTPS and have granted permission.");
            }
        }

        function adjustZoom(delta) {
            currentZoom = Math.min(Math.max(currentZoom + delta, 1), 10);
            applyZoom(currentZoom);
        }

        function applyZoom(val) {
            if (!track) return;
            zoomValueDisplay.innerText = `${val.toFixed(1)}x Magnification`;
            
            const capabilities = track.getCapabilities ? track.getCapabilities() : {};
            if (capabilities.zoom) {
                const min = capabilities.zoom.min || 1;
                const max = capabilities.zoom.max || 1;
                const hardwareVal = min + (val - 1) * (max - min) / 9;
                track.applyConstraints({ advanced: [{ zoom: hardwareVal }] }).catch(() => {});
            }

            video.style.transform = `scale(${val})`;
        }

        async function toggleTorch() {
            if (!track) return;
            try {
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                if (!capabilities.torch) {
                    showToast("Flashlight not supported on this browser/device combination.");
                    return;
                }
                torchEnabled = !torchEnabled;
                await track.applyConstraints({ advanced: [{ torch: torchEnabled }] });
                torchBtn.classList.toggle('btn-active', torchEnabled);
            } catch (e) {
                showToast("Could not toggle flashlight.");
            }
        }

        function toggleInvert() {
            isInverted = !isInverted;
            video.classList.toggle('inverted', isInverted);
            invertBtn.classList.toggle('btn-active', isInverted);
        }

        async function shareApp() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Pocket Magnifier',
                        text: 'Great app for reading small text!',
                        url: window.location.href
                    });
                } catch (err) {}
            } else {
                showToast("Share supported on mobile browsers.");
            }
        }

        function showToast(msg) {
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 5000);
        }

        // Pinch logic
        let startDist = 0;
        document.addEventListener('touchstart', e => {
            if (e.touches.length === 2) startDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        });
        document.addEventListener('touchmove', e => {
            if (e.touches.length === 2 && startDist > 0) {
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                adjustZoom((dist - startDist) / 100);
                startDist = dist;
            }
        });
    </script>
</body>
</html>

